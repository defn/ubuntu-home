#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "$shome/script/profile"

  cd "$shome"

  case "$(uname -s)" in
    Darwin)
      ${NOSUDO} sudo route -n add -net 172.17.0.0/16 172.28.128.10
      
      echo 'server=/dc1.consul/172.28.128.10' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo "address=/nih/172.28.128.10" | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      echo 'server=8.8.4.4' | tee -a "$HOME/homebrew/etc/dnsmasq.conf"
      brew services restart dnsmasq
      ;;
    Linux)
      ${NOSUDO} sudo ifconfig lo:0 172.28.29.250 netmask 255.255.255.0 up
      ${NOSUDO} sudo systemctl restart dnsmasq

      local nm_network='bridge'
      ${NOSUDO} sudo iptables -t nat -A POSTROUTING -s "$(docker network inspect "$nm_network" | jq -r '.[].IPAM.Config[].Subnet')" ! -o "$(facts | jq -r --arg gateway "$(docker network inspect "$nm_network" | jq -r '.[].IPAM.Config[].Gateway')"  'map(select(type == "object")) | map(select(.type == "bridge")) | map(select({gateway: .ipv4.address} == {gateway: $gateway})) | .[].device')" -j MASQUERADE
      ${NOSUDO} sudo sysctl -w net.ipv4.ip_forward=1

      echo "DOCKER_OPTS=\"--dns 172.17.0.1 --iptables=false\"" | ${NOSUDO} sudo tee /etc/default/docker
      ${NOSUDO} sudo systemctl restart docker
      ;;
  esac

  if [[ ! -f /config/ssh/authorized_keys ]]; then
    mkdir -p /config/ssh || ${NOSUDO} sudo install -d -m 0755 -o ubuntu -g ubuntu /config
    mkdir -p /config/ssh
    rsync -ia ~/.ssh/authorized_keys /config/ssh/authorized_keys
  fi
}

main "$@"
